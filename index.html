<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simplifying Algebraic Expressions â€“ Mr. McLean Math</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f5f5f5;
      --fg: #222222;
      --accent: #2b7cff;
      --accent-soft: #e2ecff;
      --error: #c62828;
      --correct: #2e7d32;
      --panel: #ffffff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--fg);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background: var(--accent);
      color: #ffffff;
      padding: 0.75rem 1rem;
      text-align: center;
      font-size: 1.1rem;
      font-weight: 600;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 0.75rem;
      max-width: 1200px;
      margin: 0 auto;
      gap: 0.75rem;
    }

    .top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .card {
      background: var(--panel);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .card h2 {
      margin-top: 0;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    .mode-switch {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }

    .mode-button {
      border: 1px solid var(--accent);
      background: #ffffff;
      color: var(--accent);
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .mode-button.active {
      background: var(--accent);
      color: #ffffff;
    }

    .difficulty-row {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .difficulty-button {
      border-radius: 999px;
      padding: 0.3rem 0.7rem;
      border: 1px solid #cccccc;
      background: #ffffff;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .difficulty-button span.emoji {
      font-size: 1rem;
    }

    .difficulty-button.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--fg);
      font-weight: 600;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .toggle-group {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.85rem;
    }

    .toggle-group select {
      font-size: 0.85rem;
    }

    .switch-label {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      cursor: pointer;
    }

    .switch-label input {
      cursor: pointer;
    }

    .game-area {
      flex: 1;
      min-width: 260px;
    }

    .expression-display {
      text-align: center;
      font-size: 2.1rem;
      font-weight: 600;
      margin: 0.75rem 0;
      word-wrap: break-word;
    }

    .expression-display.small {
      font-size: 1.6rem;
    }

    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    #answerInput {
      min-width: 230px;
      max-width: 480px;
      width: 100%;
      padding: 0.4rem 0.6rem;
      font-size: 1.1rem;
      border-radius: 0.5rem;
      border: 1px solid #cccccc;
    }

    button.primary {
      background: var(--accent);
      border: none;
      color: #ffffff;
      padding: 0.4rem 0.9rem;
      font-size: 0.95rem;
      border-radius: 0.5rem;
      cursor: pointer;
    }

    button.secondary {
      background: #ffffff;
      border: 1px solid #cccccc;
      color: var(--fg);
      padding: 0.35rem 0.75rem;
      font-size: 0.9rem;
      border-radius: 0.5rem;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .feedback-panel {
      font-size: 0.9rem;
      border-top: 1px solid #e0e0e0;
      padding-top: 0.5rem;
      margin-top: 0.5rem;
    }

    .feedback-status {
      font-weight: 600;
    }

    .feedback-status.correct {
      color: var(--correct);
    }

    .feedback-status.incorrect {
      color: var(--error);
    }

    .steps {
      margin-top: 0.3rem;
      font-size: 0.85rem;
      white-space: pre-line;
    }

    .score-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 0.85rem;
      margin-top: 0.4rem;
    }

    .summary-toggle {
      margin-top: 0.3rem;
      font-size: 0.85rem;
    }

    details summary {
      cursor: pointer;
    }

    .summary-list {
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }

    .summary-list ul {
      padding-left: 1.1rem;
      margin: 0.2rem 0;
    }

    .timer-display {
      font-weight: 600;
      min-width: 2.2rem;
      text-align: center;
    }

    .worksheet-area {
      display: none;
      flex-direction: column;
      gap: 0.5rem;
    }

    .worksheet-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      font-size: 0.85rem;
    }

    .worksheet-list {
      margin-top: 0.5rem;
      font-size: 1rem;
    }

    .worksheet-list ol {
      margin: 0.25rem 0;
      padding-left: 1.4rem;
    }

    .worksheet-list li {
      margin-bottom: 0.9rem; /* extra vertical space between problems */
    }

    .worksheet-answer {
      font-size: 0.9rem;
      color: #555555;
      margin-top: 0.15rem;
    }

    footer {
      text-align: center;
      padding: 0.5rem;
      font-size: 0.8rem;
      color: #666666;
    }

    .badge {
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid #dddddd;
      margin-left: 0.2rem;
    }

    .badge.easy {
      background: #e8f5e9;
    }

    .badge.medium {
      background: #fff8e1;
    }

    .badge.hard {
      background: #ffebee;
    }

    #dev-panel {
      display: none;
      font-size: 0.8rem;
      margin-top: 0.5rem;
      border-top: 1px dashed #cccccc;
      padding-top: 0.5rem;
    }

    #dev-panel pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      background: #fafafa;
      padding: 0.4rem;
      border-radius: 0.3rem;
      border: 1px solid #e0e0e0;
      max-height: 200px;
      overflow: auto;
    }

    @media (max-width: 800px) {
      .expression-display {
        font-size: 1.8rem;
      }
    }

    @media (max-width: 600px) {
      main {
        padding: 0.5rem;
      }

      .expression-display {
        font-size: 1.6rem;
      }
    }
  </style>
</head>
<body>
  <header>
    Simplifying Algebraic Expressions â€“ Practice Game
  </header>

  <main>
    <div class="top-row">
      <div class="card" style="flex: 1 1 260px;">
        <h2>Mode &amp; Settings</h2>

        <div class="mode-switch" aria-label="Mode selection">
          <button class="mode-button active" id="gameModeBtn">Game mode</button>
          <button class="mode-button" id="worksheetModeBtn">Worksheet mode</button>
        </div>

        <div>
          <strong>Difficulty</strong>
          <div class="difficulty-row" aria-label="Difficulty selection">
            <button class="difficulty-button active" data-diff="easy">
              <span class="emoji">ðŸŸ¢</span><span>Easy</span>
            </button>
            <button class="difficulty-button" data-diff="medium">
              <span class="emoji">ðŸŸ¡</span><span>Medium</span>
            </button>
            <button class="difficulty-button" data-diff="hard">
              <span class="emoji">ðŸ”´</span><span>Hard</span>
            </button>
            <button class="difficulty-button" data-diff="random">
              <span class="emoji">ðŸŽ²</span><span>Mixed</span>
            </button>
          </div>
        </div>

        <div class="controls-row" aria-label="Game controls">
          <div class="toggle-group">
            <span>Timer:</span>
            <label class="switch-label">
              <input type="checkbox" id="timerToggle" />
              <span>On</span>
            </label>
            <select id="timerSelect">
              <option value="30">30 s</option>
              <option value="60">60 s</option>
              <option value="90">90 s</option>
              <option value="120">120 s</option>
            </select>
            <span class="timer-display" id="timerDisplay">--</span>
          </div>

          <div class="toggle-group">
            <label class="switch-label">
              <input type="checkbox" id="soundToggle" checked />
              <span>Sound</span>
            </label>
          </div>

          <div class="toggle-group">
            <label class="switch-label">
              <input type="checkbox" id="contrastToggle" />
              <span>High contrast</span>
            </label>
          </div>
        </div>
      </div>

      <div class="card game-area" id="gameArea">
        <h2>Game mode</h2>
        <div id="instructionText" style="font-size:0.9rem;">
          Simplify the expression. Write the answer without parentheses.
        </div>
        <div id="expressionDisplay" class="expression-display" aria-live="polite">
          â€“
        </div>

        <div class="input-row">
          <input
            id="answerInput"
            type="text"
            autocomplete="off"
            placeholder="Write your simplified expression here (for example: 5xÂ² + 3x - 2)"
            aria-label="Type your answer"
          />
          <button id="submitBtn" class="primary">Submit</button>
          <button id="nextBtn" class="secondary">Next</button>
        </div>

        <div class="feedback-panel" aria-live="polite">
          <div id="feedbackStatus" class="feedback-status">
            &nbsp;
          </div>
          <button id="showStepsBtn" class="secondary" style="margin-top:0.25rem; display:none;">
            Show steps
          </button>
          <div id="stepsContainer" class="steps"></div>

          <div class="score-row">
            <div>Score: <span id="scoreDisplay">0</span></div>
            <div>Streak: <span id="streakDisplay">0</span></div>
            <div>Best streak: <span id="bestStreakDisplay">0</span></div>
            <div>Correct: <span id="correctDisplay">0</span></div>
            <div>Total: <span id="totalDisplay">0</span></div>
            <div>Accuracy: <span id="accuracyDisplay">0%</span></div>
          </div>

          <div class="summary-toggle">
            <details id="summaryDetails">
              <summary>Session summary (incorrect questions)</summary>
              <div class="summary-list" id="summaryList">
                No incorrect answers yet.
              </div>
            </details>
          </div>
        </div>

        <div id="dev-panel" class="card">
          <h2>Developer Tests</h2>
          <pre id="dev-output"></pre>
        </div>
      </div>

      <div class="card worksheet-area" id="worksheetArea">
        <h2>Worksheet mode</h2>
        <div class="worksheet-controls">
          <div>
            <label for="worksheetCountSelect">Number of problems:</label>
            <select id="worksheetCountSelect">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="15">15</option>
            </select>
          </div>
          <div>
            <label for="worksheetDiffSelect">Difficulty:</label>
            <select id="worksheetDiffSelect">
              <option value="easy">ðŸŸ¢ Easy</option>
              <option value="medium">ðŸŸ¡ Medium</option>
              <option value="hard">ðŸ”´ Hard</option>
              <option value="random" selected>ðŸŽ² Mixed</option>
            </select>
          </div>
          <button id="generateWorksheetBtn" class="primary">
            Generate worksheet
          </button>
          <button id="revealAllBtn" class="secondary" disabled>
            Reveal all
          </button>
          <button id="hideAllBtn" class="secondary" disabled>
            Hide all
          </button>
        </div>

        <div style="font-size:0.9rem; margin-top:0.25rem;">
          Instruction header: <strong>Simplify the expressions.</strong>
        </div>

        <div class="worksheet-list" id="worksheetList">
          No worksheet generated yet.
        </div>
      </div>
    </div>
  </main>

  <footer>
    Created by Mr. McLean Math.
  </footer>

  <script>
    /*********************
     * Utility: formatting
     *********************/

    function formatWithSpaces(num) {
      const sign = num < 0 ? "-" : "";
      let s = String(Math.abs(num));
      if (s.length <= 3) return sign + s;
      let out = "";
      while (s.length > 3) {
        out = " " + s.slice(-3) + out;
        s = s.slice(0, -3);
      }
      out = s + out;
      return sign + out;
    }

    /*********************
     * Polynomial engine
     * representation: { key: coefficient }
     * key "" => constant term
     *********************/

    function clonePoly(p) {
      const res = {};
      for (const k in p) {
        if (Object.prototype.hasOwnProperty.call(p, k)) {
          if (p[k] !== 0) res[k] = p[k];
        }
      }
      return res;
    }

    function makeConst(c) {
      return c === 0 ? {} : { "": c };
    }

    function makeMono(coef, varMap) {
      if (coef === 0) return {};
      const key = varMapToKey(varMap);
      return { [key]: coef };
    }

    function varMapToKey(map) {
      const vars = Object.keys(map).filter((v) => map[v] !== 0);
      if (vars.length === 0) return "";
      vars.sort();
      const parts = vars.map((v) => {
        const e = map[v];
        return e === 1 ? v : v + "^" + e;
      });
      return parts.join("*");
    }

    function keyToVarMap(key) {
      if (!key) return {};
      const map = {};
      const parts = key.split("*");
      for (const part of parts) {
        const m = part.match(/^([a-zA-Z])(?:\^(\d+))?$/);
        if (!m) continue;
        const v = m[1];
        const e = m[2] ? parseInt(m[2], 10) : 1;
        map[v] = (map[v] || 0) + e;
      }
      return map;
    }

    function addPolys(p, q) {
      const res = clonePoly(p);
      for (const k in q) {
        if (!Object.prototype.hasOwnProperty.call(q, k)) continue;
        res[k] = (res[k] || 0) + q[k];
        if (res[k] === 0) delete res[k];
      }
      return res;
    }

    function subPolys(p, q) {
      const res = clonePoly(p);
      for (const k in q) {
        if (!Object.prototype.hasOwnProperty.call(q, k)) continue;
        res[k] = (res[k] || 0) - q[k];
        if (res[k] === 0) delete res[k];
      }
      return res;
    }

    function mulPolys(p, q) {
      const res = {};
      for (const k1 in p) {
        if (!Object.prototype.hasOwnProperty.call(p, k1)) continue;
        const c1 = p[k1];
        const vm1 = keyToVarMap(k1);
        for (const k2 in q) {
          if (!Object.prototype.hasOwnProperty.call(q, k2)) continue;
          const c2 = q[k2];
          const vm2 = keyToVarMap(k2);
          const merged = {};
          for (const v in vm1) merged[v] = (merged[v] || 0) + vm1[v];
          for (const v in vm2) merged[v] = (merged[v] || 0) + vm2[v];
          const key = varMapToKey(merged);
          res[key] = (res[key] || 0) + c1 * c2;
          if (res[key] === 0) delete res[key];
        }
      }
      return res;
    }

    function polyToString(p) {
      const terms = [];
      for (const k in p) {
        if (!Object.prototype.hasOwnProperty.call(p, k)) continue;
        const c = p[k];
        if (c === 0) continue;
        const vm = keyToVarMap(k);
        let degree = 0;
        for (const v in vm) degree += vm[v];
        terms.push({ key: k, coef: c, degree });
      }
      if (terms.length === 0) return "0";

      terms.sort((a, b) => {
        if (b.degree !== a.degree) return b.degree - a.degree;
        if (a.key < b.key) return -1;
        if (a.key > b.key) return 1;
        return 0;
      });

      let result = "";
      for (let i = 0; i < terms.length; i++) {
        const { key, coef } = terms[i];
        const abs = Math.abs(coef);
        const sign = coef < 0 ? "-" : "+";

        let mono = "";
        if (key === "") {
          mono = formatWithSpaces(abs);
        } else {
          const varPartRaw = key
            .split("*")
            .map((part) => part.replace(/\^(\d+)/, "^$1"))
            .join("");
          const varPart = varPartRaw
            .replace(/\^2/g, "Â²")
            .replace(/\^3/g, "Â³");
          if (abs === 1) {
            mono = varPart;
          } else {
            mono = formatWithSpaces(abs) + varPart;
          }
        }

        if (i === 0) {
          result += coef < 0 ? "-" + mono : mono;
        } else {
          result += " " + sign + " " + mono;
        }
      }
      return result;
    }

    /*************************
     * Parse simplified answer
     *************************/

    function parseSimplifiedPolynomial(input) {
      let raw = (input || "").trim();
      if (!raw) return { ok: false, error: "Answer is empty." };

      // Allow users to type Â² and Â³; normalize them internally to ^2/^3
      raw = raw.replace(/Â²/g, "^2").replace(/Â³/g, "^3");

      if (/[()]/.test(raw)) {
        return {
          ok: false,
          error: "Do not use parentheses in the final answer. Expand and combine all terms."
        };
      }
      if (/[.,]/.test(raw)) {
        return {
          ok: false,
          error: "Use whole-number coefficients only (no decimals)."
        };
      }

      const s = raw.replace(/\s+/g, "");
      let str = s;
      if (str[0] !== "-" && str[0] !== "+") {
        str = "+" + str;
      }
      str = str.replace(/-/g, "+-");

      const parts = str.split("+").filter((t) => t !== "");
      const poly = {};

      for (const term of parts) {
        const m = term.match(/^(-)?(\d+)?([a-zA-Z][a-zA-Z0-9^]*)?$/);
        if (!m) {
          return {
            ok: false,
            error:
              "Could not understand part of your answer: '" +
              term +
              "'. Use terms like 3x, -2aÂ²b, 5."
          };
        }
        const negative = !!m[1];
        const numPart = m[2];
        const varPart = m[3] || "";

        let coef;
        if (numPart) {
          coef = parseInt(numPart, 10);
        } else {
          coef = varPart ? 1 : 0;
        }
        if (negative) coef = -coef;

        let key = "";
        if (varPart) {
          const map = {};
          const varMatches = varPart.match(/[a-zA-Z](?:\^\d+)?/g);
          if (!varMatches) {
            return {
              ok: false,
              error:
                "Could not read the variables in '" +
                term +
                "'. Use forms like x, yÂ², ab, aÂ²b."
            };
          }
          for (const vseg of varMatches) {
            const vm = vseg.match(/^([a-zA-Z])(?:\^(\d+))?$/);
            if (!vm) {
              return {
                ok: false,
                error:
                  "Problem with variable part '" +
                  vseg +
                  "'. Use simple letters with optional powers like xÂ²."
              };
            }
            const v = vm[1];
            const power = vm[2] ? parseInt(vm[2], 10) : 1;
            map[v] = (map[v] || 0) + power;
          }
          key = varMapToKey(map);
        }

        if (coef !== 0) {
          poly[key] = (poly[key] || 0) + coef;
          if (poly[key] === 0) delete poly[key];
        }
      }

      return { ok: true, poly };
    }

    /***********************
     * Problem generators
     ***********************/

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function randNonZero(min, max) {
      let n = 0;
      while (n === 0) {
        n = randInt(min, max);
      }
      return n;
    }

    /**
     * Each generator returns:
     * {
     *   expr: "display string",
     *   poly: polynomial object,
     *   steps: "explanation",
     *   difficulty: "easy" | "medium" | "hard"
     * }
     */

    const easyGenerators = [
      // Based on 28a: Ax + Bx - Cy
      function () {
        const A = randNonZero(1, 5);
        const B = randNonZero(1, 5);
        const C = randNonZero(1, 5);
        const expr = `${A}x + ${B}x - ${C}y`;
        const poly = addPolys(
          addPolys(makeMono(A, { x: 1 }), makeMono(B, { x: 1 })),
          makeMono(-C, { y: 1 })
        );
        const steps =
          `${expr}\n` +
          `= (${A} + ${B})x - ${C}y\n` +
          `= ${A + B}x - ${C}y`;
        return { expr, poly, steps, difficulty: "easy" };
      },
      // Based on 28b: Dy - (Ey + Fy)
      function () {
        const D = randNonZero(3, 7);
        const E = randNonZero(1, 4);
        const F = randNonZero(1, 4);
        const expr = `${D}y - (${E}y + ${F}y)`;
        const poly = subPolys(
          makeMono(D, { y: 1 }),
          addPolys(makeMono(E, { y: 1 }), makeMono(F, { y: 1 }))
        );
        const steps =
          `${expr}\n` +
          `= ${D}y - ${E}y - ${F}y\n` +
          `= (${D - E - F})y`;
        return { expr, poly, steps, difficulty: "easy" };
      },
      // Based on 29a: k(x - m)
      function () {
        const k = randNonZero(2, 5);
        const m = randInt(1, 6);
        const expr = `${k}(x - ${m})`;
        const poly = addPolys(
          makeMono(k, { x: 1 }),
          makeConst(-k * m)
        );
        const steps =
          `${expr}\n` +
          `= ${k}Â·x - ${k}Â·${m}\n` +
          `= ${k}x - ${k * m}`;
        return { expr, poly, steps, difficulty: "easy" };
      },
      // Based on 31-style: sum of like terms with constant
      function () {
        const a = randNonZero(2, 7);
        const b = randNonZero(2, 7);
        const c = randInt(-5, 5);
        const expr = `${a}x + ${b}x + ${c}`;
        const poly = addPolys(
          addPolys(makeMono(a, { x: 1 }), makeMono(b, { x: 1 })),
          makeConst(c)
        );
        const steps =
          `${expr}\n` +
          `= (${a} + ${b})x + ${c}\n` +
          `= ${a + b}x + ${c}`;
        return { expr, poly, steps, difficulty: "easy" };
      },
      // Based on 33/34: monomial products
      function () {
        const p = randNonZero(1, 5);
        const q = randNonZero(1, 5);
        const expr = `${p}x Â· ${q}x`;
        const poly = makeMono(p * q, { x: 2 });
        const steps =
          `${expr}\n` +
          `= ${p * q}xÂ²`;
        return { expr, poly, steps, difficulty: "easy" };
      },
      // Based on 36: (x + a)(x + b)
      function () {
        const a = randInt(-4, 4);
        const b = randInt(-4, 4);
        const expr = `(x + ${a}) (x + ${b})`;
        const p1 = addPolys(makeMono(1, { x: 1 }), makeConst(a));
        const p2 = addPolys(makeMono(1, { x: 1 }), makeConst(b));
        const poly = mulPolys(p1, p2);
        const steps =
          `${expr}\n` +
          `= xÂ·x + ${b}x + ${a}x + ${a * b}\n` +
          `= xÂ² + ${a + b}x + ${a * b}`;
        return { expr, poly, steps, difficulty: "easy" };
      }
    ];

    const mediumGenerators = [
      // Based on 38a: x(x - 3)
      function () {
        const k = randInt(1, 5);
        const expr = `x(x - ${k})`;
        const poly = subPolys(
          makeMono(1, { x: 2 }),
          makeMono(k, { x: 1 })
        );
        const steps =
          `${expr}\n` +
          `= xÂ·x - ${k}x\n` +
          `= xÂ² - ${k}x`;
        return { expr, poly, steps, difficulty: "medium" };
      },
      // Based on 38c/d: ay(2 - by)
      function () {
        const a = randNonZero(2, 4);
        const b = randNonZero(1, 4);
        const expr = `${a}y(2 - ${b}y)`;
        const poly = addPolys(
          makeMono(2 * a, { y: 1 }),
          makeMono(-a * b, { y: 2 })
        );
        const steps =
          `${expr}\n` +
          `= ${a}yÂ·2 - ${a}yÂ·${b}y\n` +
          `= ${2 * a}y - ${a * b}yÂ²`;
        return { expr, poly, steps, difficulty: "medium" };
      },
      // Based on 41: (2x+1)(y-1)
      function () {
        const a = randInt(1, 3);
        const b = randInt(1, 3);
        const expr = `(2x + ${a}) (y - ${b})`;
        const p1 = addPolys(makeMono(2, { x: 1 }), makeConst(a));
        const p2 = addPolys(makeMono(1, { y: 1 }), makeConst(-b));
        const poly = mulPolys(p1, p2);
        const steps =
          `${expr}\n` +
          `= (2x)Â·y + ${a}y - (2x)Â·${b} - ${a * b}\n` +
          `= 2xy + ${a}y - ${2 * b}x - ${a * b}`;
        return { expr, poly, steps, difficulty: "medium" };
      },
      // Based on 42a: a(x + 2y) - by
      function () {
        const a = randNonZero(1, 4);
        const b = randNonZero(1, 4);
        const expr = `${a}(x + 2y) - ${b}y`;
        const polyPart = addPolys(makeMono(a, { x: 1 }), makeMono(2 * a, { y: 1 }));
        const poly = subPolys(polyPart, makeMono(b, { y: 1 }));
        const steps =
          `${expr}\n` +
          `= ${a}x + ${2 * a}y - ${b}y\n` +
          `= ${a}x + ${2 * a - b}y`;
        return { expr, poly, steps, difficulty: "medium" };
      },
      // Based on 44a: 4a(b+3) + a(1-b)
      function () {
        const expr = `4a(b + 3) + a(1 - b)`;
        const part1 = addPolys(makeMono(4, { a: 1, b: 1 }), makeMono(12, { a: 1 }));
        const part2 = addPolys(makeMono(1, { a: 1 }), makeMono(-1, { a: 1, b: 1 }));
        const poly = addPolys(part1, part2);
        const steps =
          `${expr}\n` +
          `= 4ab + 12a + a - ab\n` +
          `= 3ab + 13a`;
        return { expr, poly, steps, difficulty: "medium" };
      },
      // Based on 45-style: 2y(y+a) + 6y(y-1)
      function () {
        const a = randInt(1, 4);
        const expr = `2y(y + ${a}) + 6y(y - 1)`;
        const part1 = addPolys(makeMono(2, { y: 2 }), makeMono(2 * a, { y: 1 }));
        const part2 = addPolys(makeMono(6, { y: 2 }), makeConst(-6));
        const poly = addPolys(part1, part2);
        const steps =
          `${expr}\n` +
          `= 2yÂ² + ${2 * a}y + 6yÂ² - 6\n` +
          `= 8yÂ² + ${2 * a}y - 6`;
        return { expr, poly, steps, difficulty: "medium" };
      }
    ];

    const hardGenerators = [
      // Based on 48a: 5a(a - b) - 2a(2a + b)
      function () {
        const expr = `5a(a - b) - 2a(2a + b)`;
        const p1 = addPolys(makeMono(5, { a: 2 }), makeMono(-5, { a: 1, b: 1 }));
        const p2 = addPolys(makeMono(4, { a: 2 }), makeMono(2, { a: 1, b: 1 }));
        const poly = subPolys(p1, p2);
        const steps =
          `${expr}\n` +
          `= 5aÂ² - 5ab - (4aÂ² + 2ab)\n` +
          `= 5aÂ² - 5ab - 4aÂ² - 2ab\n` +
          `= aÂ² - 7ab`;
        return { expr, poly, steps, difficulty: "hard" };
      },
      // Based on 48b style: 6xy - 2x(y - 1) - 3y(x - 1)
      function () {
        const expr = `6xy - 2x(y - 1) - 3y(x - 1)`;
        const term1 = makeMono(6, { x: 1, y: 1 });
        const t2 = subPolys(makeMono(2, { x: 1, y: 1 }), makeMono(2, { x: 1 }));
        const t3 = subPolys(makeMono(3, { x: 1, y: 1 }), makeMono(3, { y: 1 }));
        const poly = subPolys(subPolys(term1, t2), t3);
        const steps =
          `${expr}\n` +
          `= 6xy - (2xy - 2x) - (3xy - 3y)\n` +
          `= 6xy - 2xy + 2x - 3xy + 3y\n` +
          `= xy + 2x + 3y`;
        return { expr, poly, steps, difficulty: "hard" };
      },
      // Based on 49-style: 6ab - (2a + b)(a + 2b) + 2a(a + b)
      function () {
        const expr = `6ab - (2a + b)(a + 2b) + 2a(a + b)`;
        const pMid1 = addPolys(makeMono(2, { a: 1 }), makeMono(1, { b: 1 }));
        const pMid2 = addPolys(makeMono(1, { a: 1 }), makeMono(2, { b: 1 }));
        const mid = mulPolys(pMid1, pMid2);
        const last = mulPolys(
          addPolys(makeMono(2, { a: 1 }), {}),
          addPolys(makeMono(1, { a: 1 }), makeMono(1, { b: 1 }))
        );
        const start = makeMono(6, { a: 1, b: 1 });
        const poly = addPolys(subPolys(start, mid), last);
        const steps =
          `${expr}\n` +
          `= 6ab - (2aÂ² + 5ab + 2bÂ²) + (2aÂ² + 2ab)\n` +
          `= 6ab - 2aÂ² - 5ab - 2bÂ² + 2aÂ² + 2ab\n` +
          `= 3ab - 2bÂ²`;
        return { expr, poly, steps, difficulty: "hard" };
      },
      // Based on 52a (using c instead of z)
      function () {
        const expr = `3y(2y + c) - 3y(y - 2c) - 3y(y + 3c)`;
        const t1 = addPolys(makeMono(6, { y: 2 }), makeMono(3, { y: 1, c: 1 }));
        const t2 = addPolys(makeMono(3, { y: 2 }), makeMono(-6, { y: 1, c: 1 }));
        const t3 = addPolys(makeMono(3, { y: 2 }), makeMono(9, { y: 1, c: 1 }));
        const poly = subPolys(subPolys(t1, t2), t3);
        const steps =
          `${expr}\n` +
          `= (6yÂ² + 3yc) - (3yÂ² - 6yc) - (3yÂ² + 9yc)\n` +
          `= 6yÂ² + 3yc - 3yÂ² + 6yc - 3yÂ² - 9yc\n` +
          `= 0`;
        return { expr, poly, steps, difficulty: "hard" };
      },
      // Based on 53a: (2x-1)(3x+2) - (x-3)(2x-5)
      function () {
        const expr = `(2x - 1)(3x + 2) - (x - 3)(2x - 5)`;
        const p1 = addPolys(makeMono(2, { x: 1 }), makeConst(-1));
        const p2 = addPolys(makeMono(3, { x: 1 }), makeConst(2));
        const p3 = addPolys(makeMono(1, { x: 1 }), makeConst(-3));
        const p4 = addPolys(makeMono(2, { x: 1 }), makeConst(-5));
        const first = mulPolys(p1, p2);
        const second = mulPolys(p3, p4);
        const poly = subPolys(first, second);
        const steps =
          `${expr}\n` +
          `= (6xÂ² + x - 2) - (2xÂ² - 11x + 15)\n` +
          `= 6xÂ² + x - 2 - 2xÂ² + 11x - 15\n` +
          `= 4xÂ² + 12x - 17`;
        return { expr, poly, steps, difficulty: "hard" };
      }
    ];

    function generateProblemByDifficulty(diff) {
      if (diff === "random") {
        const pool = ["easy", "medium", "hard"];
        diff = pool[randInt(0, pool.length - 1)];
      }
      let genArray;
      if (diff === "easy") genArray = easyGenerators;
      else if (diff === "medium") genArray = mediumGenerators;
      else genArray = hardGenerators;

      const gen = genArray[randInt(0, genArray.length - 1)];
      const prob = gen();
      prob.difficulty = diff;
      return prob;
    }

    /*********************
     * Game state
     *********************/

    const difficultyButtons = document.querySelectorAll(".difficulty-button");
    const expressionDisplay = document.getElementById("expressionDisplay");
    const answerInput = document.getElementById("answerInput");
    const submitBtn = document.getElementById("submitBtn");
    const nextBtn = document.getElementById("nextBtn");
    const feedbackStatus = document.getElementById("feedbackStatus");
    const stepsContainer = document.getElementById("stepsContainer");
    const showStepsBtn = document.getElementById("showStepsBtn");

    const scoreDisplay = document.getElementById("scoreDisplay");
    const streakDisplay = document.getElementById("streakDisplay");
    const bestStreakDisplay = document.getElementById("bestStreakDisplay");
    const correctDisplay = document.getElementById("correctDisplay");
    const totalDisplay = document.getElementById("totalDisplay");
    const accuracyDisplay = document.getElementById("accuracyDisplay");
    const summaryList = document.getElementById("summaryList");

    const timerToggle = document.getElementById("timerToggle");
    const timerSelect = document.getElementById("timerSelect");
    const timerDisplay = document.getElementById("timerDisplay");
    const soundToggle = document.getElementById("soundToggle");
    const contrastToggle = document.getElementById("contrastToggle");

    const gameModeBtn = document.getElementById("gameModeBtn");
    const worksheetModeBtn = document.getElementById("worksheetModeBtn");
    const gameArea = document.getElementById("gameArea");
    const worksheetArea = document.getElementById("worksheetArea");

    const worksheetCountSelect = document.getElementById("worksheetCountSelect");
    const worksheetDiffSelect = document.getElementById("worksheetDiffSelect");
    const generateWorksheetBtn = document.getElementById("generateWorksheetBtn");
    const worksheetList = document.getElementById("worksheetList");
    const revealAllBtn = document.getElementById("revealAllBtn");
    const hideAllBtn = document.getElementById("hideAllBtn");

    let currentDifficulty = "easy";
    let currentProblem = null;
    let lastAnswerCorrect = false;

    let score = 0;
    let streak = 0;
    let bestStreak = 0;
    let correctCount = 0;
    let totalCount = 0;
    let incorrectHistory = [];

    let timerId = null;
    let timerRemaining = 0;

    function setDifficulty(diff) {
      currentDifficulty = diff;
      difficultyButtons.forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.diff === diff);
      });
      newProblem();
    }

    difficultyButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        setDifficulty(btn.dataset.diff);
      });
    });

    function updateScoreDisplays() {
      scoreDisplay.textContent = score;
      streakDisplay.textContent = streak;
      bestStreakDisplay.textContent = bestStreak;
      correctDisplay.textContent = correctCount;
      totalDisplay.textContent = totalCount;
      const acc = totalCount === 0 ? 0 : Math.round((100 * correctCount) / totalCount);
      accuracyDisplay.textContent = acc + "%";

      if (incorrectHistory.length === 0) {
        summaryList.textContent = "No incorrect answers yet.";
      } else {
        const ul = document.createElement("ul");
        for (const item of incorrectHistory) {
          const li = document.createElement("li");
          li.textContent =
            item.expr + "  â†’  Correct: " + item.correct + "  | Your answer: " + item.your;
          ul.appendChild(li);
        }
        summaryList.innerHTML = "";
        summaryList.appendChild(ul);
      }
    }

    function resetFeedback() {
      feedbackStatus.textContent = "";
      feedbackStatus.className = "feedback-status";
      stepsContainer.textContent = "";
      showStepsBtn.style.display = "none";
      lastAnswerCorrect = false;
    }

    function newProblem() {
      resetFeedback();
      currentProblem = generateProblemByDifficulty(currentDifficulty);
      expressionDisplay.textContent = currentProblem.expr
        .replace(/\^2/g, "Â²")
        .replace(/\^3/g, "Â³");
      answerInput.value = "";
      answerInput.focus();
      if (timerToggle.checked) {
        startTimer();
      } else {
        stopTimer();
      }
    }

    function startTimer() {
      stopTimer();
      timerRemaining = parseInt(timerSelect.value, 10);
      timerDisplay.textContent = timerRemaining;
      timerId = setInterval(() => {
        timerRemaining--;
        if (timerRemaining <= 0) {
          timerDisplay.textContent = "0";
          stopTimer();
        } else {
          timerDisplay.textContent = timerRemaining;
        }
      }, 1000);
    }

    function stopTimer() {
      if (timerId !== null) {
        clearInterval(timerId);
        timerId = null;
      }
      timerDisplay.textContent = timerToggle.checked ? timerRemaining : "--";
    }

    function playBeep(type) {
      if (!soundToggle.checked) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = type === "correct" ? 880 : 220;
        gain.gain.setValueAtTime(0.15, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.2);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.21);
      } catch (e) {
        // ignore audio errors
      }
    }

    contrastToggle.addEventListener("change", () => {
      if (contrastToggle.checked) {
        document.body.style.background = "#000000";
        document.body.style.color = "#ffffff";
      } else {
        document.body.style.background = getComputedStyle(document.documentElement)
          .getPropertyValue("--bg");
        document.body.style.color = getComputedStyle(document.documentElement)
          .getPropertyValue("--fg");
      }
    });

    timerToggle.addEventListener("change", () => {
      if (timerToggle.checked) {
        startTimer();
      } else {
        stopTimer();
      }
    });

    function checkAnswer() {
      if (!currentProblem) return;
      const userText = answerInput.value;
      const parsed = parseSimplifiedPolynomial(userText);
      if (!parsed.ok) {
        feedbackStatus.textContent = parsed.error;
        feedbackStatus.className = "feedback-status incorrect";
        showStepsBtn.style.display = "none";
        stepsContainer.textContent = "";
        playBeep("wrong");
        return;
      }

      const userPoly = parsed.poly;
      const expectedPoly = currentProblem.poly;

      const same =
        Object.keys(userPoly).length === Object.keys(expectedPoly).length &&
        Object.keys(userPoly).every(
          (k) => Object.prototype.hasOwnProperty.call(expectedPoly, k) && userPoly[k] === expectedPoly[k]
        );

      totalCount++;
      if (same) {
        correctCount++;
        streak++;
        if (streak > bestStreak) bestStreak = streak;
        score += 10;
        if (streak > 0 && streak % 5 === 0) score += 5;

        feedbackStatus.textContent = "Correct!";
        feedbackStatus.className = "feedback-status correct";
        showStepsBtn.style.display = "none";
        stepsContainer.textContent = "";
        lastAnswerCorrect = true;
        playBeep("correct");
      } else {
        streak = 0;
        feedbackStatus.textContent = "Incorrect. Try again or show steps.";
        feedbackStatus.className = "feedback-status incorrect";
        showStepsBtn.style.display = "inline-block";
        stepsContainer.textContent = "";
        lastAnswerCorrect = false;
        incorrectHistory.push({
          expr: expressionDisplay.textContent,
          correct: polyToString(expectedPoly),
          your: polyToString(userPoly)
        });
        playBeep("wrong");
      }
      updateScoreDisplays();
    }

    submitBtn.addEventListener("click", () => {
      if (lastAnswerCorrect) {
        newProblem();
      } else {
        checkAnswer();
      }
    });

    nextBtn.addEventListener("click", () => {
      newProblem();
    });

    answerInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        if (lastAnswerCorrect) {
          newProblem();
        } else {
          checkAnswer();
        }
      } else if (e.key === "Escape") {
        e.preventDefault();
        answerInput.value = "";
      }
    });

    showStepsBtn.addEventListener("click", () => {
      if (!currentProblem) return;
      const final = polyToString(currentProblem.poly);
      stepsContainer.textContent =
        currentProblem.steps.replace(/\^2/g, "Â²").replace(/\^3/g, "Â³") +
        "\nFinal answer: " +
        final;
    });

    /********************
     * Worksheet logic
     ********************/

    let worksheetProblems = [];

    function updateWorksheetDisplay() {
      if (!worksheetProblems.length) {
        worksheetList.textContent = "No worksheet generated yet.";
        revealAllBtn.disabled = true;
        hideAllBtn.disabled = true;
        return;
      }
      const ol = document.createElement("ol");
      worksheetProblems.forEach((p, index) => {
        const li = document.createElement("li");
        const line = document.createElement("div");
        line.textContent = p.expr.replace(/\^2/g, "Â²").replace(/\^3/g, "Â³");
        const ans = document.createElement("div");
        ans.className = "worksheet-answer";
        ans.textContent = "Answer: " + polyToString(p.poly);
        if (!p.revealed) ans.style.display = "none";
        li.appendChild(line);
        li.appendChild(ans);
        li.dataset.index = String(index);
        ol.appendChild(li);
      });
      worksheetList.innerHTML = "";
      worksheetList.appendChild(ol);
      revealAllBtn.disabled = false;
      hideAllBtn.disabled = false;
    }

    generateWorksheetBtn.addEventListener("click", () => {
      const count = parseInt(worksheetCountSelect.value, 10);
      const diff = worksheetDiffSelect.value;
      worksheetProblems = [];
      for (let i = 0; i < count; i++) {
        const p = generateProblemByDifficulty(diff);
        p.revealed = false;
        worksheetProblems.push(p);
      }
      updateWorksheetDisplay();
    });

    revealAllBtn.addEventListener("click", () => {
      worksheetProblems.forEach((p) => (p.revealed = true));
      updateWorksheetDisplay();
    });

    hideAllBtn.addEventListener("click", () => {
      worksheetProblems.forEach((p) => (p.revealed = false));
      updateWorksheetDisplay();
    });

    /********************
     * Mode switching
     ********************/

    function setMode(mode) {
      if (mode === "game") {
        gameArea.style.display = "block";
        worksheetArea.style.display = "none";
        gameModeBtn.classList.add("active");
        worksheetModeBtn.classList.remove("active");
      } else {
        gameArea.style.display = "none";
        worksheetArea.style.display = "flex";
        gameModeBtn.classList.remove("active");
        worksheetModeBtn.classList.add("active");
      }
    }

    gameModeBtn.addEventListener("click", () => setMode("game"));
    worksheetModeBtn.addEventListener("click", () => setMode("worksheet"));

    /********************
     * Dev tests
     ********************/

    function runDevTests() {
      const out = [];
      function test(name, fn) {
        try {
          const result = fn();
          out.push((result ? "âœ… " : "âŒ ") + name);
        } catch (e) {
          out.push("âŒ " + name + " (error: " + e.message + ")");
        }
      }

      test("Easy coefficient bounds", () => {
        for (let i = 0; i < 40; i++) {
          const p = generateProblemByDifficulty("easy").poly;
          for (const k in p) {
            if (!Object.prototype.hasOwnProperty.call(p, k)) continue;
            if (Math.abs(p[k]) > 30) return false;
          }
        }
        return true;
      });

      test("Medium coefficient bounds", () => {
        for (let i = 0; i < 40; i++) {
          const p = generateProblemByDifficulty("medium").poly;
          for (const k in p) {
            if (!Object.prototype.hasOwnProperty.call(p, k)) continue;
            if (Math.abs(p[k]) > 60) return false;
          }
        }
        return true;
      });

      test("Hard coefficient bounds", () => {
        for (let i = 0; i < 40; i++) {
          const p = generateProblemByDifficulty("hard").poly;
          for (const k in p) {
            if (!Object.prototype.hasOwnProperty.call(p, k)) continue;
            if (Math.abs(p[k]) > 100) return false;
          }
        }
        return true;
      });

      test("No variable z generated", () => {
        const regex = /z/;
        for (let i = 0; i < 60; i++) {
          const pr = generateProblemByDifficulty("random");
          if (regex.test(pr.expr)) return false;
        }
        return true;
      });

      test("Sample simplification: 2(x + 3)", () => {
        const p = addPolys(makeMono(2, { x: 1 }), makeConst(6));
        return polyToString(p) === "2x + 6";
      });

      test("Sample simplification: 8a - 4(2a - b) = 4b", () => {
        const p = makeMono(4, { b: 1 });
        const target = makeMono(4, { b: 1 });
        return (
          Object.keys(p).length === Object.keys(target).length &&
          Object.keys(p).every(
            (k) => Object.prototype.hasOwnProperty.call(target, k) && p[k] === target[k]
          )
        );
      });

      test("Sample simplification: 5a(a - b) - 2a(2a + b) = aÂ² - 7ab", () => {
        const p1 = addPolys(makeMono(5, { a: 2 }), makeMono(-5, { a: 1, b: 1 }));
        const p2 = addPolys(makeMono(4, { a: 2 }), makeMono(2, { a: 1, b: 1 }));
        const p = subPolys(p1, p2);
        const target = addPolys(makeMono(1, { a: 2 }), makeMono(-7, { a: 1, b: 1 }));
        return (
          Object.keys(p).length === Object.keys(target).length &&
          Object.keys(p).every(
            (k) => Object.prototype.hasOwnProperty.call(target, k) && p[k] === target[k]
          )
        );
      });

      test("Parser: 3x + 2x - 5 equals 5x - 5", () => {
        const u = parseSimplifiedPolynomial("3x + 2x - 5");
        const v = parseSimplifiedPolynomial("5x - 5");
        if (!u.ok || !v.ok) return false;
        const up = u.poly;
        const vp = v.poly;
        return (
          Object.keys(up).length === Object.keys(vp).length &&
          Object.keys(up).every(
            (k) => Object.prototype.hasOwnProperty.call(vp, k) && up[k] === vp[k]
          )
        );
      });

      test("Parser distinguishes 5x - 5 and 5x + 5", () => {
        const u = parseSimplifiedPolynomial("5x - 5");
        const v = parseSimplifiedPolynomial("5x + 5");
        if (!u.ok || !v.ok) return false;
        const up = u.poly;
        const vp = v.poly;
        const same =
          Object.keys(up).length === Object.keys(vp).length &&
          Object.keys(up).every(
            (k) => Object.prototype.hasOwnProperty.call(vp, k) && up[k] === vp[k]
          );
        return !same;
      });

      test("Correct answer logic test", () => {
        const p = generateProblemByDifficulty("easy");
        const expected = polyToString(p.poly);
        const parsed = parseSimplifiedPolynomial(expected);
        if (!parsed.ok) return false;
        const userPoly = parsed.poly;
        const same =
          Object.keys(userPoly).length === Object.keys(p.poly).length &&
          Object.keys(userPoly).every(
            (k) => Object.prototype.hasOwnProperty.call(p.poly, k) && userPoly[k] === p.poly[k]
          );
        return same;
      });

      test("Random difficulty picks all three types", () => {
        const seen = { easy: false, medium: false, hard: false };
        for (let i = 0; i < 60; i++) {
          const p = generateProblemByDifficulty("random");
          seen[p.difficulty] = true;
        }
        return seen.easy && seen.medium && seen.hard;
      });

      return out.join("\n");
    }

    (function () {
      const params = new URLSearchParams(window.location.search);
      if (params.get("dev") === "1") {
        const panel = document.getElementById("dev-panel");
        const out = document.getElementById("dev-output");
        panel.style.display = "block";
        out.textContent = runDevTests();
      }
    })();

    // Initialize
    updateScoreDisplays();
    setDifficulty("easy");
    newProblem();
  </script>
</body>
</html>
